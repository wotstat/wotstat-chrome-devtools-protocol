# [POC] Chrome Devtools Protocol (CDP) implementation for World of Tanks Gameface

![](https://github.com/user-attachments/assets/785d0b52-c704-4458-8afa-c7c7295a791a)

> **POC – Prof of Concept может работать не совсем корректно и иметь баги.**

Проект реализует поддержку Chrome Devtools Protocol (CDP) для Gameface части игры World of Tanks, что позволяет использовать Chrome Devtools для просмотра и отладки UI игры и модов.

## Использование
1. Установите [wot.gameface](https://gitlab.com/openwg/wot.gameface)
   - Для `Lesta` скачайте `wot.gameface` из релизов этого репозитория (пропатченная версия под Lesta)
2. Установите [wotstat.chrome-devtools-protocol](https://github.com/wotstat/wotstat-chrome-devtools-protocol/releases/latest) из релизов
3. Запустите игру
4. Откройте в хроме `chrome://inspect`
5. Нажмите на "Configure..." и добавьте `localhost:9222` если его там нет
6. Дождитесь пока появится список таргетов
7. Нажмите на "inspect" рядом с нужным таргетом
8. Используйте Devtools как обычно


## Функционал
Реализован не весь CDP, а только минимальный функционал для работы с DOM, CSS и Runtime.

- DOM:
  - Ленивый просмотр DOM дерева, подгружает только необходимые узлы
  - Просмотр всех аттрибутов элементов
  - Изменение аттрибутов элементов
  - Изменение текста узлов
  - Просмотр как `edit as HTML`
  - Копирование и вставка узлов
  - Перемещение узлов
- Overlay:
  - Подсветка элементов при наведении в дереве
  - Отображение размеров и отступов элементов
  - Отображение корректных оверлеев при наведение в стилях
  - Element picker для выбора элемента на странице (кликать прямо в игре)
- CSS:
  - Просмотр и **редактирование** стилей элементов
  - Просмотр иерархии стилей элементов (какие стили откуда применяются)
  - Просмотр Computed стилей элементов
  - Редактирование custom.css стиля через вкладку Sources
- Runtime:
  - Выполнение JS кода в контексте страницы
  - Просмотр объектов и их свойств

## Известные ограничения
- DOM:
  - Не поддерживают псевдоэлементы `::before` и `::after`
  - Аттрибуты обновляются раз в 300мс (throttle)
  - Плохо работает `setInnerHTML`, в теории работать должен, но в Gameface что-то ломается
  - `appendChild` работает только для новых элементов, при перемещении существующих элементов они не отображаются в дереве, нужно перезапускать Devtools
- CSS:
  - Инлайн стили можно отключать, но Gameface удаляет `/* style */` дефинишены, поэтому, отключенные стили перемещаются в `_style` атрибут.
  - Отключенные стили в css файлах удаляются.
  - Не поддерживают псевдоэлементы `::before` и `::after`
  - Не поддерживается переопределение состояний (`:hov`, `:active`, `:focus` и т.д.).
  - Gameface сам разворачивает шорткаты в полные свойства, чтоб увидеть замену в Devtools, нужно переключить активный элемент в дереве туда-сюда.
  - Редактирование `custom.css` умеет только устанавливать значения, если вы удалите строчку, то Gameface всё равно сохраняет кеш стиля. Например при установке цвета `red`, а потом удалении этой строки, цвет останется `red`.
- Runtime:
  - Не поддерживаются `const` и `let`, используйте просто определение `foo = 123`
  - Подсказки кода работают частично, так как нет возможности однозначно определить side effects free properties
  - Предпросмотр объектов иногда не отображается, и виден `{}` как будто бы пустой, хотя на самом деле там есть свойства, достаточно развернуть объект в консоли


## Разработка
Мод запускает HTTP + WebSocket сервер на порту 9222. Хукается `ViewComponent.initChildren` и инжектируется `CDPView`, которая попадает в каждый компонент Gameface.

`CDPView` инжектирует `js` скрипт, который и отвечает за реализацию протокола. 

### Коммуникация между python и js
Команды `Devtools -> python -> JS` обрабатываются через запись в реактивное поле `CDPModel`, а ответы `JS -> python -> Devtools` отправляются через `_addCommand`. Перед отправкой следующей команды, `CDPModel` ждет подтверждение о получении предыдущей.

Команды `python -> JS` батчатся в массивы по `1/30` секунды для уменьшения количества пересылок.

> [!IMPORTANT]
> Если вы знаете как реализовать `Python -> JS` коммуникацию явно, сделайте это. Текущая реализация костыльная и может приводить к багам.

### JS
Написана на `TypeScript`, собирается в один файл с помощью `vite`. 
Около 60% когда это AI Bullshit. Требует рефакторинга.

Есть тестовый сервер, для проверки работы вне игры. Учитывайте, что рантайм Gameface отличается от браузерного.

Полезно включить вкладку `Protocol Monitor` в Devtools для отладки.


## Полезные ссылки
- [Chrome Devtools Protocol](https://chromedevtools.github.io/devtools-protocol/) – официальная документация CDP
- [Devtools Remote Debugger](https://github.com/Nice-PLQ/devtools-remote-debugger) – реализация CDP в браузере для удалённой отладки